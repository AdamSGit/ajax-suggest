(function(e){e.fn.ajaxSuggest=function(t){var n=this;this.s=e.extend({t:null,delay:400,s:false,minLength:3,url:"",cl:0,noResult:"No result found",field:"value",arr:null},t);this.init=function(){this.ul=e("<ul>");this.el=e("<div>").addClass("ajax-suggest").append(this.ul);this.target=e(this.get(0));this.target.prop("autocomplete","off");if(this.target.val().length)this.s.cl=this.target.val().length;if(this.target.attr("data-url"))this.s.url=this.target.attr("data-url");e("body").first().append(this.el.css("visibility","hidden"));this.target.on("keyup",r.start)};this.position=function(){var t=this.target.offset(),n=0,r=0,i=0,s=e(document).scrollTop();n=t.top+this.target.outerHeight()-s;if(n/e(window).height()>.7){i=t.top-s-20}else{i=e(window).height()-n-20}this.el.css({maxHeight:i});if(n/e(window).height()>.7){r=t.top-this.el.outerHeight()-10}else{r=t.top+this.target.outerHeight()+10}this.el.css({width:this.target.outerWidth(),top:r,left:t.left});this.t=r;this.l=t.left;this.w=this.el.outerWidth();this.h=this.el.outerHeight()};this.max_exec=function(e,t){var n=t!==undefined?t:this.s.delay;if(!this.toDo||!this.s.t||(new Date).getTime()*1e3-this.s.t<n){if(this.toDo)clearTimeout(this.toDo);this.toDo=setTimeout(e,n);this.s.t=(new Date).getTime()*1e3}};this.resize=function(){this.max_exec(function(e){return function(){e.position();e.toDo=null}}(this))};this.show=function(){var t=this;this.position();if(!this.s.s){this.el.css("visibility","visible");e(window).on("resize",r.resize);e(window).on("click",r.hide_mouse);e(window).on("keyup",r.escape);this.s.s=true}};this.hide=function(){this.s.s=false;this.el.css("visibility","hidden");e(window).off("resize",r.resize);this.ul.find("li:not(.disabled)").off("click")};this.hide_mouse=function(e){if((e.pageX<this.l||e.pageX>this.l+this.w)&&(e.pageY<this.t||e.pageY>this.t))this.hide()};this.escape=function(e){if(e.keyCode===27)this.hide()};this.start=function(){var e=this;if(this.target.val().length>=this.s.minLength){if(this.target.val().length!=this.s.cl){this.max_exec(function(t){return function(){if(e.s.arr){t.getScope()}else{t.getAjax()}t.toDo=null}}(this),700)}}else if(this.s.s)this.empty().hide();this.s.cl=this.target.val().length};this.empty=function(){this.ul.empty();e(window).off("keydown",r.browse);return this};this.getAjax=function(){var t=this;if(this.s.url){if(this.xhr&&this.xhr.readystate!=4)this.xhr.abort();this.xhr=e.ajax({url:this.s.url,type:"POST",dataType:"json",data:{val:this.target.val()}}).done(function(e){t.done.call(t,e)}).fail(this.fail)}};this.getScope=function(){if(this.s.arr&&Object.prototype.toString.call(this.s.arr)==="[object Array]"){var e=[],t=this.target.val();for(var n in this.s.arr){if(this.s.arr[n][this.s.field].toLowerCase().indexOf(t.toLowerCase())!==-1){e.push(this.s.arr[n])}}this.done(e)}};this.done=function(t){this.empty();if(t.length){this.data=t;for(var n in t){var i=e("<li>").attr("data-key",n).text(t[n][this.s.field]);if(n==0)i.addClass("active");this.ul.append(i)}e(window).on("keydown",r.browse);this.ul.find("li:not(.disabled)").on("click",function(t){r.click_li(t,e(this).attr("data-key"))})}else this.ul.append(e("<li>").attr("data-key",0).text(this.s.noResult).addClass("disabled"));this.show()};this.fail=function(e,t,n){console.log("Ajax error : "+t)};this.browse=function(e){if(e.keyCode===40||e.keyCode===38||e.keyCode===13)e.preventDefault();var t=this.ul.find("li:not(.disabled)"),n=elthis.s.filter(".active").first();if(t.length>1){if(e.keyCode===40){n.removeClass("active");if(n.next().length){n.next().addClass("active")}else{t.first().addClass("active")}}else if(e.keyCode===38){n.removeClass("active");if(n.prev().length){n.prev().addClass("active")}else{t.last().addClass("active")}}}if(t.length&&(e.keyCode===13||e.keyCode===9)){this.set(n.attr("data-key"))}};this.click_li=function(e,t){e.preventDefault();this.set(t)};this.set=function(t){if(this.data[t]!==undefined){var n=this.data[t];this.target.val(n[this.s.field]);this.s.cl=n[this.s.field].length;for(var r in n){if(r!==this.s.field){var i="ajax-suggest-"+r;input=e("#"+i);if(!input.length)input=e("<input>").prop({id:i,name:i,type:"hidden"}).insertBefore(this.target);input.val(n[r])}}}this.empty().hide()};this.toDo=null;this.w=null;this.h=null;this.t=null;this.l=null;this.xhr=null;this.data=null;var r={show:function(){n.show()},resize:function(){n.resize()},hide_mouse:function(e){n.hide_mouse(e)},escape:function(e){n.escape(e)},start:function(){n.start()},browse:function(e){n.browse(e)},click_li:function(e,t){n.click_li(e,t)}};try{if(this.length){if(this.get(0).nodeName!=="INPUT")throw new TypeError("The targeted element must be an input ! Interruption.");if(this.get(0).name==="")throw new TypeError("The targeted element has no name ! Interruption.");this.init();return this}}catch(i){console.log(i.name+": "+i.message)}}})(jQuery);(function(){$("[data-ajax-suggest-input]").ajaxSuggest()})()